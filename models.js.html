<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: models.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: models.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * The data-layer for a message wall
 * @module models
 */
'use strict';

var mongoose = require('mongoose'),
  _ = require('lodash'),
  Schema = mongoose.Schema;

/**
 * Message schema, contains replies too
 * @constructor Message
 */
var MessageSchema = new Schema({
  subject: {
    type: String
  },
  author: {
    type: Schema.Types.ObjectId,
    required: true
  },
  message: {
    type: String,
    required: true
  },
  replies: [MessageSchema],
  readBy: [Schema.Types.ObjectId]
});

/**
 * Our root class that runs everything
 *
 * @constructor Wall
 */
var WallSchema = new Schema({
  title: {
    type: String,
    required: true
  },
  participants: [{
    object: {
      type: Schema.Types.ObjectId,
      required: true
    },
    role: {
      type: String,
      required: true,
      default: 'member',
      enum: ['member', 'editor', 'admin']
    }
  }],
  messages: [MessageSchema]
});

/**
 * Helper method to check is a given ObjectID has the necessary role
 *
 * @function isParticipant
 * @memberof Wall
 * @this Wall
 * @param {ObjectId} object
 * @params {Array} roles, defaults to all
 * @returns Participant or null
 */
WallSchema.method('isParticipant', function(object, roles) {
  if(!roles) {
    roles = ['admin', 'editor', 'member'];
  }
  return _.find(this.participants, function(p){
    return p.object.equals( object ) &amp;&amp; roles.indexOf(p.role) > -1;
  });
});

/**
 * Adds a new message to the wall
 *
 * @function addMessage
 * @memberof Wall
 * @this Wall
 * @param data: JSON of the message with required keys title (string), author (objectId), message (string)
 * @param callback: called with (err, wall)
 */
WallSchema.method('addMessage', function(data, cb){
  if(this.isParticipant(data.author, ['admin', 'editor'])) {
    this.messages.push(data);
    this.save(cb);
  } else {
    cb(new Error('Author is not allowed to create a message on this wall'));
  }
});
/**
 * Adds a reply to a message
 *
 * @function replyTo
 * @memberof Wall
 * @this Wall
 * @param data: JSON of the reply with required keys replyTo (message index), message (string), author (objecId)
 * @param callback: called with (err, wall)
 */
WallSchema.method('replyTo', function(data, cb){
  if(this.isParticipant(data.author)) {
    this.messages[data.replyTo].replies.push({
      message: data.message,
      author: data.author
    });
    this.save(cb);
  } else {
    cb(new Error('Author is not allowed to create a replies on this wall'));
  }
});
/**
 * Sets a read flag on a message for a reader
 *
 * @function read
 * @memberof Wall
 * @this Wall
 * @param data: JSON with keys message (message index), reader (objectId)
 * @param callback: called with (err, wall)
 */
WallSchema.method('read', function(data, cb){
  this.messages[data.message].readBy.push(data.reader);
  this.save(cb);
});

mongoose.model('Wall', WallSchema);
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-index.html">index</a></li><li><a href="module-models.html">models</a></li><li><a href="module-WallAPI.html">WallAPI</a></li></ul><h3>Classes</h3><ul><li><a href="module-models-Message.html">Message</a></li><li><a href="module-models-Wall.html">Wall</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-beta1</a> on Sat Feb 14 2015 16:34:08 GMT+0100 (CET)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
